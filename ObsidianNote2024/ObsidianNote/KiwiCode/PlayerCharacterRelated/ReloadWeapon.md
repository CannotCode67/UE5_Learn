This script is responsible for reloading the weapon. We can add this functionality into the weapon manager script, only to make a big class even bigger, but conceptually, it might belong there.

To get the result we want, we use animation rigging combined with animation event. In addition to the animation riggin infrastrcture, we also need to modify the weapon prefab a little bit. We need to have a magazine game object under the weapon object, so when we set the magazine object to inactive, it appears as if the weapon is without a magazine attached. Also we need a standalone magazine prefab as well.

Now, with all the preparations ready, we first record the reload animation clip. Then, we add animation events on frames where the character detaches the magazine, drops the detached magazine, refills the magazine, and attach the new magazine. However, we don't have any event for the animation to broadcast. We define the event in a script called WeaponAnimationEvents or similar. We need to attach this script to the game object which the animator is attached to, because the animator is searching for events to invoke but it only searches the game object it is attached to.

Inside this WeaponAnimationEvents script, but outside the WeaponAnimationEvents class definition, we first define an event class called AnimationEvent inheriting from the UnityEvent class of string type. So we can invoke this type of event passing string value as event data. In the WeaponAnimationEvents class, we first get an instance of our defined event. Then, we put it inside a built-in method called OnAnimationEvent(string eventName) to invoke. This built-in method is what the animator is searching, and we can fill any type of parameter only as long as the invoking event is passing the value of the same type.

With all that done, we can go to animation window to click those reload animation events, now we should see we can select the function, and fill in the parameter to pass along. In example, we fill in string values of detach_mag, drop_mag, refill_mag, attach_mag. So when the clip plays to the spot where the character detaches the magazine, the animation event is fired with information of detach_mag string value, the same for the rest.

Going back to the ReloadWeapon script, now we need to listen to the event we just broadcast. First get the reference of the WeaponAnimationEvents script, and in Start(), we add listener to the event. Now we write the listener method called OnAnimationEvent(). We take the string parameter, and run a switch statement on it, creating four cases, each one matching the four string values. For organizing purpose, in each case we call a method named simialr to that string value. Like for detach_mag string value, we call the DetachMag() method. In DetachMag(), we first get the active weapon, instantiate the appropriate magazine game object, put it under leftHand joint as child object, then set the weapon's magazine game object to inactive. Next, it is the DropMag() method, in which we instantiate another magazine game object using the world transform of the magazine under the leftHand joint. This one has no parent object, as we want it to drop and react as other game prop with physics in the world. We add the rigidbody and box collider components. Then set the leftHand joint's child magazine to inactive. This is why a magazine prefab would be more performance friendly so we don't add components on the fly. RefillMag() only sets the magazine under leftHand joint active again. The last one is AttachMag(), in which we set the weapon's child magazine active again, destroy the magazine under leftHand joint, tell the animator to reset the animator trigger parameter.

Now the reload clip, animation event, and event listener method are all ready. We just need a way to start this clip, and everything would work together. In the Update loop, check for input to set the animation trigger parameter. If we don't reset this trigger parameter in AttachMag(), it is possible that the clip would play again. Also remember to uncheck the write default option in the animator states for both reloading clips.

