The Recoil script is in charge of the shaking effect when we fire a weapon. The shaking effect is composed of three parts: the camera shake, the crosshair shake, and the character and weapon shake.

First for the camera shake, because we are using cinemachine virtual camera. We can add extensions to add certain functionalities to our camera. The extension we use for recoil is called Cinemachine Impulse Listener. It contains three parts. The extension we added to the virtual camera, the Cinemachine Impulse Listener.  Then, we need to add a built-in script to our character, called Cinemachine Impulse Source. This script takes in a noise setting object, which we can create in asset menu and assign it. One of them is Cinemachine Impulse Listener extension, which takes a noise setting. Just create it in project windown and assign it. Inside the setting, we can set the noise for position and rotation, but it would only happen when we tell the impulse source to do it by calling GenerateImpulse() method. Without much work, this now handles the camera shake.

For the crosshair shake, becasue our crosshair always resides in the center of our screen, all we need to do is to alter the mouse positions. We use cinemachine's axisState class to store our mouse movements, so we just need to add influence to the axisState's value property. However, directly adding the influence would make the crosshair instantly jump to the place after the influenced. We actually want the crosshair to move to that place smoothly. Therefore, the way to do it is to spread the influence amount over each frame. We have a public property called verticalRecoilSpeed, and a public property called duration. Create a method called GenerateRecoil(), and this method would be called by the weapon script's FiringBullet() method. And we want to put all the shaking implementation in this method, so we first put the GenerateImpulse() method inside it. Then, we set the private property time to equal to the duration. In Update loop, we first check if the private property time is bigger than zero, if so, we get the axisState's value and add on the influence of verticalRecoil times deltaTime, then the private property time would subtract the deltaTime. Now, each time this GenerateRecoil() is called, the time is set to duration, and before the time becomes zero or less, we apply the recoil to the axisState's value. The result is good, but when we tune the property, we actually want a recoil distance and the time it takes to get there. Therefore, in Update loop, we use the recoil to divide the duration to achieve that. Even we do it in multiple frames, we are actually using the recoil speed to times the duration to get the distance. But dividing the duration, the recoil speed property now represents the distance. However, the sum of deltaTime in all these frames usually gets bigger than duration, so this is not a 100% accurate way.

By now, the GenerateRecoil() method contains the calling of GenerateImpulse(), which take cares the camera shake, and the setting the time property to duration, which triggers the crosshair shake in Update loop. The last part is the character and weapon shake. We do this through animation rigging. For the character shake, we add a bodyRecoil object under the upper body bend rig layer, put the object after the spine aim, but before the head aim. This way, the constraints should happen in the right order. We apply OverrideTransform component to the bodyRecoil object, constraining the character's spine 2 joint, that's why we put it after spine aim, and the source target is the bodyRecoil object itself. The OverrideTransform component would add the transform value of the source target onto the transform of constraint object. We also need a weaponRecoil object with the same component, added to the weapon aim rig layer, after the weapon aim pose. Its constraint object is the weapon holder or weapon pivot. Then, we record two animation clips, one for rifle and one for pistol. In each clip, we modify two recoid object's position and rotation to create extra transform values to add on the constraining objects, making the character's body to push back a little, the gun barrel go up a little, just like the reactions when a real weapon is fired. Once we have the clips, we add one more animation layer called recoil layer. Create two states, one for rifle, and one for pistol. Both of them only transit back to empty. And, lastly, inside the GenerateRecoil() method, we tell the animator to play the appropriate clip basd on the state name. To do that, we need the active weapon name, so either the GenerateRecoil() method needs this as parameter or the Recoil script has a reference to the weapon manager script to call the GetActiveWeapon() method.